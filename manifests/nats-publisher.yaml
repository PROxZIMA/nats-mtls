apiVersion: apps/v1
kind: Deployment
metadata:
  name: nats-publisher
  namespace: nats-system
  labels:
    app: nats-publisher
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nats-publisher
  template:
    metadata:
      labels:
        app: nats-publisher
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/skip-outbound-ports: "4222"
    spec:
      containers:
      - name: publisher
        image: natsio/nats-box:latest
        env:
        - name: NATS_URL
          value: "tls://nats-broker.nats-system.svc.cluster.local:4222"
        - name: SUBJECT
          value: "test.messages"
        - name: NATS_CERT
          value: "/etc/nats/certs/client/tls.crt"
        - name: NATS_KEY
          value: "/etc/nats/certs/client/tls.key"
        - name: NATS_CA
          value: "/etc/nats/certs/ca/ca.crt"
        command:
        - "/bin/sh"
        - "-c"
        - |
          echo "Starting NATS Publisher with mTLS..."
          echo "Connecting to: $NATS_URL"
          echo "Subject: $SUBJECT"
          echo "Client Cert: $NATS_CERT"
          echo "CA Cert: $NATS_CA"
          echo ""
          
          # Wait a bit for NATS to be ready
          sleep 5
          
          counter=0
          while true; do
            timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            message="Message #$counter - Published at $timestamp"
            
            nats pub "$SUBJECT" "$message" \
              --server="$NATS_URL" \
              --tlscert="$NATS_CERT" \
              --tlskey="$NATS_KEY" \
              --tlsca="$NATS_CA"
            
            if [ $? -eq 0 ]; then
              echo "[$(date -u +"%Y-%m-%d %H:%M:%S")] ✓ Published: $message"
            else
              echo "[$(date -u +"%Y-%m-%d %H:%M:%S")] ✗ Failed to publish message"
            fi
            
            counter=$((counter + 1))
            sleep 5
          done
        volumeMounts:
        - name: client-tls
          mountPath: /etc/nats/certs/client
          readOnly: true
        - name: ca-cert
          mountPath: /etc/nats/certs/ca
          readOnly: true
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
      volumes:
      - name: client-tls
        secret:
          secretName: nats-publisher-client-tls
      - name: ca-cert
        secret:
          secretName: nats-ca
