apiVersion: apps/v1
kind: Deployment
metadata:
  name: nats-subscriber
  namespace: nats-system
  labels:
    app: nats-subscriber
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nats-subscriber
  template:
    metadata:
      labels:
        app: nats-subscriber
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/skip-outbound-ports: "4222"
    spec:
      containers:
      - name: subscriber
        image: natsio/nats-box:latest
        env:
        - name: NATS_URL
          value: "tls://nats-leaf.nats-system.svc.cluster.local:4222"
        - name: SUBJECT
          value: "test.messages"
        - name: NATS_CERT
          value: "/etc/nats/certs/client/tls.crt"
        - name: NATS_KEY
          value: "/etc/nats/certs/client/tls.key"
        - name: NATS_CA
          value: "/etc/nats/certs/ca/ca.crt"
        command:
        - "/bin/sh"
        - "-c"
        - |
          echo "Starting NATS Subscriber with mTLS..."
          echo "Connecting to: $NATS_URL"
          echo "Subject: $SUBJECT"
          echo "Client Cert: $NATS_CERT"
          echo "CA Cert: $NATS_CA"
          echo ""
          
          # Wait a bit for NATS leaf to be ready
          sleep 10
          
          echo "Subscribing to messages..."
          echo ""
          
          # Continuously subscribe with auto-reconnect
          while true; do
            nats sub "$SUBJECT" \
              --server="$NATS_URL" \
              --tlscert="$NATS_CERT" \
              --tlskey="$NATS_KEY" \
              --tlsca="$NATS_CA" \
              2>&1 | while IFS= read -r line; do
                timestamp=$(date -u +"%Y-%m-%d %H:%M:%S")
                # Filter out subscription confirmation messages
                if echo "$line" | grep -qE "^[0-9]{2}:[0-9]{2}:[0-9]{2}|^\[#[0-9]+\]"; then
                  echo "[$timestamp] ✓ Received: $line"
                elif echo "$line" | grep -q "Message #"; then
                  echo "[$timestamp] ✓ Received: $line"
                fi
              done
            
            # If subscription ends, wait and retry
            echo "[$(date -u +"%Y-%m-%d %H:%M:%S")] ⚠ Subscription ended, reconnecting..."
            sleep 5
          done
        volumeMounts:
        - name: client-tls
          mountPath: /etc/nats/certs/client
          readOnly: true
        - name: ca-cert
          mountPath: /etc/nats/certs/ca
          readOnly: true
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
      volumes:
      - name: client-tls
        secret:
          secretName: nats-subscriber-client-tls
      - name: ca-cert
        secret:
          secretName: nats-ca
