apiVersion: apps/v1
kind: Deployment
metadata:
  name: nats-subscriber
  namespace: nats-system
  labels:
    app: nats-subscriber
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nats-subscriber
  template:
    metadata:
      labels:
        app: nats-subscriber
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/skip-outbound-ports: "4222"
    spec:
      containers:
      - name: subscriber
        image: natsio/nats-box:latest
        env:
        - name: NATS_URL
          value: "nats://nats-leaf.nats-system.svc.cluster.local:4222"
        - name: NATS_USER
          valueFrom:
            secretKeyRef:
              name: nats-auth
              key: username
        - name: NATS_PASS
          valueFrom:
            secretKeyRef:
              name: nats-auth
              key: password
        - name: SUBJECT
          value: "test.messages"
        command:
        - "/bin/sh"
        - "-c"
        - |
          echo "Starting NATS Subscriber..."
          echo "Connecting to: $NATS_URL"
          echo "Subject: $SUBJECT"
          echo ""
          
          # Wait a bit for NATS leaf to be ready
          sleep 10
          
          echo "Subscribing to messages..."
          echo ""
          
          # Continuously subscribe with auto-reconnect
          while true; do
            nats sub "$SUBJECT" \
              --server="$NATS_URL" \
              # --user="$NATS_USER" \
              # --password="$NATS_PASS" \
              2>&1 | while IFS= read -r line; do
                timestamp=$(date -u +"%Y-%m-%d %H:%M:%S")
                # Filter out subscription confirmation messages
                if echo "$line" | grep -qE "^[0-9]{2}:[0-9]{2}:[0-9]{2}|^\[#[0-9]+\]"; then
                  echo "[$timestamp] ✓ Received: $line"
                elif echo "$line" | grep -q "Message #"; then
                  echo "[$timestamp] ✓ Received: $line"
                fi
              done
            
            # If subscription ends, wait and retry
            echo "[$(date -u +"%Y-%m-%d %H:%M:%S")] ⚠ Subscription ended, reconnecting..."
            sleep 5
          done
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
