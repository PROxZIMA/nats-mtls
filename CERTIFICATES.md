# Certificate Setup Guide

## Overview

This guide explains the Linkerd certificate setup for cross-cluster mTLS communication.

## Certificate Hierarchy

```
Root CA (ca.crt + ca.key)
├── Cluster A Identity Issuer (cluster-a-issuer.crt + cluster-a-issuer.key)
│   └── Workload Certificates (auto-generated by Linkerd for each pod in Cluster A)
└── Cluster B Identity Issuer (cluster-b-issuer.crt + cluster-b-issuer.key)
    └── Workload Certificates (auto-generated by Linkerd for each pod in Cluster B)
```

## Why Shared Root CA?

Both clusters use the **same Root CA** but **different identity issuers**. This allows:

1. ✅ Pods in Cluster A can verify certificates from pods in Cluster B
2. ✅ Pods in Cluster B can verify certificates from pods in Cluster A
3. ✅ True cross-cluster mTLS communication
4. ✅ Each cluster maintains independent identity management

## Certificate Details

### Root CA
- **File**: `ca.crt`, `ca.key`
- **Purpose**: Trust anchor shared by both clusters
- **Validity**: 365 days (configurable)
- **Common Name**: `root.linkerd.cluster.local`

### Cluster A Identity Issuer
- **Files**: `cluster-a-issuer.crt`, `cluster-a-issuer.key`
- **Purpose**: Issues certificates for workloads in VM A
- **Validity**: 365 days (configurable)
- **Common Name**: `identity.linkerd.cluster.local`

### Cluster B Identity Issuer
- **Files**: `cluster-b-issuer.crt`, `cluster-b-issuer.key`
- **Purpose**: Issues certificates for workloads in VM B
- **Validity**: 365 days (configurable)
- **Common Name**: `identity.linkerd.cluster.local`

## Generation Process

The `generate-certificates.sh` script uses `step-cli` to:

1. Create a root CA certificate and key
2. Create intermediate certificate for Cluster A signed by root CA
3. Create intermediate certificate for Cluster B signed by root CA

## Security Best Practices

### For POC/Testing
- ✅ Use `--no-password` for automation
- ✅ 365-day validity is acceptable
- ✅ Store certificates in version control is OK (this is a test)

### For Production
- ❌ Never use `--no-password` - protect private keys
- ❌ Store keys in secure vault (HashiCorp Vault, AWS Secrets Manager)
- ❌ Use shorter validity periods (90 days) with auto-rotation
- ❌ Never commit keys to version control
- ❌ Implement certificate rotation procedures
- ❌ Use hardware security modules (HSM) for key storage
- ❌ Regular certificate auditing

## Certificate Distribution

### VM A Needs:
```
vm-a-broker/certs/
├── ca.crt                    # Root CA certificate
├── cluster-a-issuer.crt      # Cluster A identity issuer certificate
└── cluster-a-issuer.key      # Cluster A identity issuer private key
```

### VM B Needs:
```
vm-b-leaf/certs/
├── ca.crt                    # Root CA certificate (same as VM A)
├── cluster-b-issuer.crt      # Cluster B identity issuer certificate
└── cluster-b-issuer.key      # Cluster B identity issuer private key
```

## Verification

### Check Certificate Chain

```bash
# Verify Cluster A issuer is signed by root CA
openssl verify -CAfile certs/ca.crt certs/cluster-a-issuer.crt

# Verify Cluster B issuer is signed by root CA
openssl verify -CAfile certs/ca.crt certs/cluster-b-issuer.crt
```

### View Certificate Details

```bash
# Root CA
openssl x509 -in certs/ca.crt -noout -text

# Cluster A issuer
openssl x509 -in certs/cluster-a-issuer.crt -noout -text

# Cluster B issuer
openssl x509 -in certs/cluster-b-issuer.crt -noout -text
```

### Check Expiry Dates

```bash
# Root CA expiry
openssl x509 -in certs/ca.crt -noout -enddate

# Cluster A issuer expiry
openssl x509 -in certs/cluster-a-issuer.crt -noout -enddate

# Cluster B issuer expiry
openssl x509 -in certs/cluster-b-issuer.crt -noout -enddate
```

## Certificate Rotation

### When to Rotate
- Before certificates expire (plan for 30 days before expiry)
- After security incidents
- Regular rotation schedule (every 90 days for production)

### How to Rotate

1. Generate new certificates using same root CA:
```bash
./shared/generate-certificates.sh
```

2. Update Linkerd on VM A:
```bash
linkerd upgrade \
  --identity-trust-anchors-file vm-a-broker/certs/ca.crt \
  --identity-issuer-certificate-file vm-a-broker/certs/cluster-a-issuer.crt \
  --identity-issuer-key-file vm-a-broker/certs/cluster-a-issuer.key \
  | kubectl apply -f -
```

3. Update Linkerd on VM B:
```bash
linkerd upgrade \
  --identity-trust-anchors-file vm-b-leaf/certs/ca.crt \
  --identity-issuer-certificate-file vm-b-leaf/certs/cluster-b-issuer.crt \
  --identity-issuer-key-file vm-b-leaf/certs/cluster-b-issuer.key \
  | kubectl apply -f -
```

4. Restart pods to get new certificates:
```bash
# VM A
kubectl rollout restart deployment -n nats-system

# VM B
kubectl rollout restart deployment -n nats-system
```

## Troubleshooting

### Certificate Verification Failed

```bash
# Check if pods trust the root CA
linkerd identity -n nats-system -l app=nats-broker

# Expected output should show:
# - Valid certificate
# - Issuer: identity.linkerd.cluster.local
# - Trust anchors: root.linkerd.cluster.local
```

### Cross-Cluster mTLS Not Working

```bash
# On VM A - check Linkerd identity
linkerd identity -n nats-system -l app=nats-broker

# On VM B - check Linkerd identity
linkerd identity -n nats-system -l app=nats-leaf

# Both should show the same root CA in trust anchors
```

### Certificate Expired

```bash
# Check expiry
openssl x509 -in certs/ca.crt -noout -dates

# If expired, generate new certificates and rotate
./shared/generate-certificates.sh
# Then follow rotation procedure
```

## Additional Resources

- [Linkerd Certificate Management](https://linkerd.io/2/tasks/automatically-rotating-control-plane-tls-credentials/)
- [Step CLI Documentation](https://smallstep.com/docs/step-cli)
- [OpenSSL Certificate Verification](https://www.openssl.org/docs/man1.1.1/man1/verify.html)
